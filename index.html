<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>제품 위치 찾기 - 스프레드시트 그대로</title>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 30px;
}
h2 { text-align: center; }
input, button { padding: 6px; margin: 5px; }
#sheetButtons { display: flex; flex-wrap: wrap; justify-content: center; margin: 10px 0; }
#sheetButtons span { margin-right: 10px; font-weight: bold; align-self: center; }
table { border-collapse: collapse; margin: 20px 0; }
td, th { padding: 6px 12px; text-align: center; }
.highlight { background-color: yellow; font-weight: bold; }
</style>
</head>
<body>

<h2>제품 위치 찾기 (스프레드시트 그대로)</h2>
<input type="text" id="searchBox" placeholder="제품명을 입력하세요">
<button onclick="searchProduct()">찾기</button>
<div id="sheetButtons"></div>
<table id="productTable"></table>

<script>
const SPREADSHEET_ID = "14eYGH3njFIqQr7pX8ClJ5LdIiNnQ272QOYiyeTzATsM"; // 실제 ID로 교체
const API_KEY = "AIzaSyDhgt-UIJklNeg-Jjky0-3piV6XQx4nrsc"; // 실제 API Key로 교체
const SHEETS = ["MAIN","DSI","TEST"];

let matchingSheets = [];
let currentSearchValue = "";

// 시트 값 + 서식 가져오기
async function fetchSheet(sheetName) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?fields=sheets(properties(title),data(rowData(values(userEnteredFormat(backgroundColor,borders,horizontalAlignment,verticalAlignment)),formattedValue)))&key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  const sheetObj = data.sheets.find(s=>s.properties.title===sheetName);
  if(!sheetObj || !sheetObj.data || !sheetObj.data[0]?.rowData) return [];
  return sheetObj.data[0].rowData.map(row => row.values || []);
}

// 테이블 생성
function displaySheet(sheet) {
  const table = document.getElementById("productTable");
  table.innerHTML="";
  const searchValue = currentSearchValue;

  sheet.forEach((row,rowIndex)=>{
    const tr = document.createElement("tr");
    row.forEach((cell,colIndex)=>{
      const td = document.createElement(rowIndex===0?'th':'td');

      // 값 표시
      td.textContent = cell?.formattedValue || "";

      // 검색 하이라이트
      if(typeof td.textContent==="string" && td.textContent.toLowerCase().includes(searchValue)){
        td.classList.add("highlight");
      }

      // 배경색 적용
      if(cell?.userEnteredFormat?.backgroundColor){
        const bg = cell.userEnteredFormat.backgroundColor;
        const r = Math.round((bg.red??1)*255);
        const g = Math.round((bg.green??1)*255);
        const b = Math.round((bg.blue??1)*255);
        td.style.backgroundColor = `rgb(${r},${g},${b})`;
      }

      // 테두리 적용
      const borders = cell?.userEnteredFormat?.borders;
      if(borders){
        if(borders.top?.style) td.style.borderTop = "1px solid #aaa";
        if(borders.bottom?.style) td.style.borderBottom = "1px solid #aaa";
        if(borders.left?.style) td.style.borderLeft = "1px solid #aaa";
        if(borders.right?.style) td.style.borderRight = "1px solid #aaa";
      }

      // 정렬
      const hAlign = cell?.userEnteredFormat?.horizontalAlignment;
      if(hAlign) td.style.textAlign = hAlign;
      const vAlign = cell?.userEnteredFormat?.verticalAlignment;
      if(vAlign) td.style.verticalAlign = vAlign;

      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

// 검색 기능
async function searchProduct(){
  const searchValue = document.getElementById("searchBox").value.trim().toLowerCase();
  currentSearchValue = searchValue;

  const table = document.getElementById("productTable");
  const sheetButtons = document.getElementById("sheetButtons");
  table.innerHTML="";
  sheetButtons.innerHTML="";

  if(searchValue.length < 5){
    alert("제품명을 최소 5자 이상 입력해주세요.");
    return;
  }

  matchingSheets = [];

  for(const sheet of SHEETS){
    const rows = await fetchSheet(sheet);
    const hasProduct = rows.some(row=>row.some(cell=>typeof(cell?.formattedValue)==="string" && cell.formattedValue.toLowerCase().includes(searchValue)));
    if(hasProduct){
      matchingSheets.push(rows);
    }
  }

  if(matchingSheets.length===0){
    alert("제품을 찾을 수 없습니다.");
    return;
  }

  if(matchingSheets.length===1){
    displaySheet(matchingSheets[0]);
    return;
  }

  const label = document.createElement("span");
  label.textContent = "조회할 시트를 선택해 주세요:";
  sheetButtons.appendChild(label);

  matchingSheets.forEach((sheet,index)=>{
    const btn = document.createElement("button");
    btn.textContent = SHEETS[index];
    btn.onclick = ()=>displaySheet(sheet);
    sheetButtons.appendChild(btn);
  });
}
</script>

</body>
</html>
