<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>제품 위치/후처리(도금견적) 찾기(DoubleH 25.10.24)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin: 30px;
    }

    h2 {
      color: #333;
      text-align: center;
    }

    input, button, select {
      padding: 6px;
      margin: 5px;
      text-align: center;
    }

    #sheetButtons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px 0;
    }

    #sheetButtons span {
      margin-right: 10px;
      font-weight: bold;
      align-self: center;
    }

    table {
      border-collapse: collapse;
      margin: 20px 0;
      width: auto;
      text-align: center;
    }

    td, th {
      border: 1px solid #aaa;
      padding: 6px 12px;
      text-align: center;
    }

    .highlight {
      background-color: yellow;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>제품 위치/후처리(도금견적) 찾기 </h2>

  <input type="text" id="searchBox" placeholder="제품명을 입력하세요">
  <button onclick="searchProduct()">찾기</button>
  <h2>update 25.10.24</h2>

  <div id="sheetButtons"></div>
  <table id="productTable"></table>

  <script>
    const SPREADSHEET_ID = "14eYGH3njFIqQr7pX8ClJ5LdIiNnQ272QOYiyeTzATsM";
    const API_KEY = "AIzaSyDhgt-UIJklNeg-Jjky0-3piV6XQx4nrsc";
    const SHEETS = ["MAIN", "DSI", "24년도 재고조사","25년도 도금견적","24년도 도금견적","23년도 도금견적"];

    let matchingSheets = [];
    let currentSearchValue = "";

    // ✅ 시트 데이터 가져오기
    async function fetchSheet(sheetName) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}?key=${API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.values || [];
    }

    // ✅ 조건에 따라 시트 표시
    function displaySheet(rows, searchValue) {
      const table = document.getElementById("productTable");
      table.innerHTML = "";

      const totalRows = rows.length;
      const header = rows[0];

      let displayRows = [];

      if (totalRows <= 100) {
        // ✅ 100행 이하 → 전체 표시
        displayRows = rows.slice(1);
      } else {
        // ✅ 101행 이상 → 검색 결과만 표시
        displayRows = rows.slice(1).filter(row =>
          row.some(cell => typeof cell === "string" && cell.toLowerCase().includes(searchValue))
        );
      }

      if (displayRows.length === 0) {
        table.innerHTML = "<tr><td>검색 결과가 없습니다.</td></tr>";
        return;
      }

      // 헤더 표시
      const headerRow = document.createElement("tr");
      header.forEach(cell => {
        const th = document.createElement("th");
        th.textContent = cell;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      // 행 표시
      displayRows.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          if (typeof cell === "string" && cell.toLowerCase().includes(searchValue)) {
            td.classList.add("highlight");
          }
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });

      // ✅ 자동 스크롤 (highlight 위치로)
      setTimeout(() => {
        const firstHighlight = document.querySelector(".highlight");
        if (firstHighlight) {
          firstHighlight.scrollIntoView({ behavior: "smooth", block: "center" });
          firstHighlight.style.outline = "3px solid orange";
        }
      }, 300);
    }

    // ✅ 검색 수행
    async function searchProduct() {
      const searchValue = document.getElementById("searchBox").value.trim().toLowerCase();
      currentSearchValue = searchValue;

      const table = document.getElementById("productTable");
      const sheetButtons = document.getElementById("sheetButtons");
      table.innerHTML = "";
      sheetButtons.innerHTML = "";

      if (searchValue.length < 2) {
        alert("제품명을 최소 2자 이상 입력해주세요.");
        return;
      }

      matchingSheets = [];

      // 모든 시트 검색
      for (let sheet of SHEETS) {
        const rows = await fetchSheet(sheet);
        const hasProduct = rows.some(row =>
          row.some(cell => typeof cell === "string" && cell.toLowerCase().includes(searchValue))
        );
        if (hasProduct) {
          matchingSheets.push({ name: sheet, data: rows });
        }
      }

      if (matchingSheets.length === 0) {
        alert("제품을 찾을 수 없습니다.");
        return;
      }

      // ✅ 결과가 하나면 바로 표시
      if (matchingSheets.length === 1) {
        displaySheet(matchingSheets[0].data, searchValue);
        return;
      }

      // ✅ 여러 시트면 버튼 표시
      const label = document.createElement("span");
      label.textContent = "조회할 시트를 선택해 주세요:";
      sheetButtons.appendChild(label);

      matchingSheets.forEach(sheet => {
        const btn = document.createElement("button");
        btn.textContent = sheet.name;
        btn.onclick = () => displaySheet(sheet.data, searchValue);
        sheetButtons.appendChild(btn);
      });
    }
  </script>

</body>
</html>
